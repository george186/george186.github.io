---

title: 二次注入

date: 2021-07-14 13:40:09

tags: 笔记

categories: note9

---

# 二次注入

由于前段时间的期末考试以及老师讲课进度比较慢，所以把时间大多花在了学习上，如今再次捡起，还是要从sql注入开始，今天学一个很重要的sql注入——二次注入。  

## 什么是二次注入？
 ——何为二次注入？

 ——为了预防SQL注入攻击，而将输入到应用程序中的某些数据进行了“转义（escape）”，但是这些数据却又在“未被转义（Unescaped）”的查询窗体中重复使用。

这里提到了转义一词，而这个转义所用到的函数也正是我们之前所遇到的addslashes()函数，这个函数在很多sql注入中起到转义的作用，而它具体的转义原理可以回顾之前我写的那一篇wp。  

也就是说二次注入和普通注入的最大区别就是二次注入要注入两次，二第一次注入正是为了给第二次注入铺垫条件的。  

## 漏洞原因  

那么为什么会产生二次注入的漏洞呢？这个很好理解。  

对于一般的注入，当我们构造完sql语句并且提交后，语句是会立即生效的。而对于二次注入则不是这样。   

二次注入会对第一次构造的语句进行过滤转义，也就是用到了上面说到的函数，这就造成我们第一次构造的sql语句无法生效。但是二次注入的漏洞就在于当我们第二次构造sql注入时它是没有转义过滤机制的（而第二次注入在题目中的表现一般为修改密码等修改信息类的操作）。那么我们就可以利用这一点，在第一次注入的时候先构造一个恶意的sql语句，然后再用第二次sql注入利用起来，从而达到sql注入的效果。  

## 实例演示  

用模拟登陆和修改密码进行操作：  

首先假设我们注册了两个用户：  

	用户1名字为“csdner”，密码是“csdner123456”；

    用户2名字为“csndner'--” ，密码是“csdner1111”。  

注意这里的用户2的名字是sql注入的有效负载，为**csndner'--**这个奇怪的名字不会被转义或者截断，也就原样保存在数据库中。  

接下来我们修改用户2的密码为csdn222，那么我们的sql语句应该是以下这样：  

	UPDATE users
	SET password='csdn222'
	WHERE username='csdner'--' and password='csdn1111'

我们已经知道--在sql语句中是注释的意思，所以说这个修改的sql语句在--后面的语句都被注释掉了，那么它的最终执行的语句就是这样的：  

	UPDATE users
	SET password='csdn222'
	WHERE username='csdner'

这就导致我们修改的密码是用户csdner的密码，这就可以让我们在原本不知道csdner用户的密码的情况下修改它的密码并且登录，达到了二次注入的效果。  

# 小结  

简单总结一下二次注入，我们可以分为两部，第一步就是第一次构造恶意的sql语句（不会被转义截断的有效负载），为我们第二次注入构造条件。第二部就是配合第一次的恶意语句来进行sql注入，达到一般sql注入的目的。  

总的来说，目前看到的SQL注入大都是利用报错注入来查看数据的，关于这一点的题型应该还有别的，遇到了在做总结吧。

参考：[SQL二次注入](https://blog.csdn.net/weixin_42574142/article/details/83388231?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162134760816780357292461%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=162134760816780357292461&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~times_rank-1-83388231.first_rank_v2_pc_rank_v29&utm_term=sql%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5&spm=1018.2226.3001.4449)